<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loggr | Professional Time Tracker</title>
    
    <!-- Dynamic Favicon (Clipboard Logo) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect width='8' height='4' x='8' y='2' rx='1' ry='1'/><path d='M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'/><path d='M12 11h4'/><path d='M12 16h4'/><path d='M8 11h.01'/><path d='M8 16h.01'/></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        accent: "#3b82f6", // Blue 500
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Base Theme (Dark Mode Default) --- */
        body {
            background-color: #0f172a; /* Slate 900 */
            /* Adjusted radial gradients to be Blue/Slate based instead of Purple */
            background-image: 
                radial-gradient(at 0% 0%, hsla(222,47%,11%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(210,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(199,49%,30%,1) 0, transparent 50%);
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- Light Mode Overrides --- */
        body.light-mode {
            background-color: #f8fafc;
            /* Adjusted light mode gradients to be lighter Blue/Sky */
            background-image: 
                radial-gradient(at 0% 0%, hsla(210, 50%, 95%, 1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(199, 50%, 90%, 1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(222, 50%, 95%, 1) 0, transparent 50%);
            color: #334155; /* Slate 700 */
        }

        /* Glassmorphism Utilities - Dark Mode */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            user-select: none;
            touch-action: manipulation;
        }

        .glass-card:hover, .glass-card:focus {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            border-color: rgba(59, 130, 246, 0.4); /* Blue border */
            box-shadow: 0 4px 20px -5px rgba(59, 130, 246, 0.3);
            outline: none;
        }
        
        .glass-card:focus-visible {
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.2s;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #3b82f6; /* Blue */
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* --- Glassmorphism Utilities - Light Mode Overrides --- */
        body.light-mode .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        body.light-mode .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            color: #1e293b;
        }

        body.light-mode .glass-card:hover, body.light-mode .glass-card:focus {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.6));
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        }

        body.light-mode .glass-input {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(203, 213, 225, 0.6); 
            color: #1e293b; 
        }
        
        body.light-mode .glass-input:focus {
            background: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
        }

        /* Text utility overrides for light mode */
        body.light-mode .text-slate-400 { color: #64748b; } 
        body.light-mode .text-slate-300 { color: #475569; } 
        body.light-mode .text-white { color: #1e293b; } 
        
        /* Updated overrides for Blue/Cyan theme */
        body.light-mode .text-blue-300 { color: #2563eb; } /* Blue 600 */
        body.light-mode .text-cyan-300 { color: #0891b2; } /* Cyan 600 */
        body.light-mode .text-emerald-300 { color: #059669; } 
        body.light-mode .text-red-300 { color: #dc2626; } 

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        body.light-mode ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        body.light-mode ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Drag and Drop Ghost */
        .sortable-ghost {
            opacity: 0.2;
            background: #3b82f6; /* Blue */
        }
        .sortable-drag {
            cursor: grabbing;
            opacity: 1;
            background: rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #3b82f6;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms ease-out, transform 200ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 150ms ease-in, transform 150ms ease-in;
        }

        /* Toast Notification Light Mode Overrides */
        body.light-mode #toast {
            background-color: #ffffff;
            border-color: #e2e8f0; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        body.light-mode #toast .text-green-400 {
            color: #15803d; 
        }
        body.light-mode #btn-toast-undo {
            border-color: #e2e8f0;
        }
        body.light-mode #btn-toast-undo:hover {
            color: #1e3a8a; /* Blue 900 */
        }

        /* Utility to force text size on mobile inputs to prevent zoom */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body class="transition-colors duration-500">

    <!-- App Root -->
    <div id="app" class="relative min-h-screen flex flex-col items-center justify-center p-4">
        
        <!-- Loading Spinner -->
        <div id="loading-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 transition-opacity duration-500">
            <div class="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-slate-400 text-sm tracking-widest uppercase animate-pulse">Initializing Loggr</p>
        </div>

        <!-- Auth View -->
        <div id="auth-view" class="hidden w-full max-w-md animate-slide-up">
            <div class="glass-panel p-8 rounded-3xl relative overflow-hidden">
                <!-- Background decorative blob -->
                <!-- Changed colors to Blue/Sky -->
                <div class="absolute -top-20 -right-20 w-40 h-40 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
                <div class="absolute -bottom-20 -left-20 w-40 h-40 bg-sky-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 2s"></div>

                <div class="relative z-10 text-center">
                    <div class="mb-6 flex justify-center">
                        <div class="bg-gradient-to-tr from-blue-500 to-cyan-500 p-3 rounded-2xl shadow-lg shadow-blue-500/30">
                            <!-- CHANGED LOGO: Clipboard List -->
                            <i data-lucide="clipboard-list" class="w-8 h-8 text-white"></i>
                        </div>
                    </div>
                    <h1 id="auth-title" class="text-3xl font-bold mb-2 tracking-tight">Welcome to Loggr</h1>
                    <p id="auth-subtitle" class="text-slate-400 mb-8 text-sm">Professional Day Orchestrator</p>

                    <form id="login-form" class="space-y-4 text-left">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Email</label>
                            <input type="email" id="email" class="glass-input w-full px-4 py-3 rounded-xl text-base" placeholder="you@company.com" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Password</label>
                            <input type="password" id="password" class="glass-input w-full px-4 py-3 rounded-xl text-base" placeholder="••••••••" required>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs text-slate-400 mt-2">
                             <label class="flex items-center gap-2 cursor-pointer">
                                <!-- Changed focus ring color -->
                                <input type="checkbox" id="remember-me" class="rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-transparent">
                                <span>Remember me</span>
                            </label>
                            <button type="button" id="btn-forgot-password" class="hover:text-blue-400 transition-colors">Forgot Password?</button>
                        </div>

                        <!-- Button Gradient Updated -->
                        <button type="submit" id="btn-auth-submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-medium py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition-all transform active:scale-95 flex justify-center items-center gap-2 mt-6">
                            <span>Sign In</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>

                    <div class="mt-6 pt-6 border-t border-white/10 text-xs text-slate-400">
                        <span id="auth-switch-text">Don't have an account?</span>
                        <button id="btn-switch-auth" class="text-blue-400 hover:text-blue-300 font-semibold ml-1 transition-colors">Create Profile</button>
                    </div>

                    <p id="auth-error" class="text-red-400 text-xs mt-4 hidden text-center bg-red-500/10 p-2 rounded-lg border border-red-500/20"></p>
                    <p id="auth-success" class="text-emerald-400 text-xs mt-4 hidden text-center bg-emerald-500/10 p-2 rounded-lg border border-emerald-500/20"></p>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden w-full max-w-7xl h-full flex flex-col animate-fade-in pb-10">
            
            <!-- Header -->
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-tr from-blue-500 to-cyan-500 p-2.5 rounded-xl shadow-lg shadow-blue-500/20">
                        <!-- LOGO updated here too -->
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h2 id="current-date" class="text-xl font-bold tracking-tight text-white">Today</h2>
                        <div class="flex items-center gap-2 text-xs text-slate-400">
                            <span id="user-email-display">user@loggr.app</span>
                            <span class="w-1 h-1 bg-slate-500 rounded-full"></span>
                            <button id="btn-logout" class="hover:text-white transition-colors">Sign Out</button>
                        </div>
                    </div>
                </div>

                <!-- Settings Bar -->
                <div class="glass-panel px-4 py-3 rounded-xl flex flex-wrap items-center gap-4 md:gap-6 text-sm">
                    <button id="btn-theme-toggle" class="p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-yellow-400 transition-colors" title="Toggle Light/Dark Mode">
                        <i data-lucide="sun" class="w-4 h-4 hidden dark-icon"></i>
                        <i data-lucide="moon" class="w-4 h-4 light-icon"></i>
                    </button>
                    <div class="w-px h-4 bg-white/10 hidden sm:block"></div>
                    <div class="flex items-center gap-2">
                        <!-- Updated icon color -->
                        <i data-lucide="clock" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-slate-400 hidden sm:inline">Shift Start:</span>
                        <input type="time" id="setting-start-time" class="bg-transparent border-none text-white focus:ring-0 cursor-pointer font-medium text-base" value="08:00">
                    </div>
                    <div class="w-px h-4 bg-white/10 hidden sm:block"></div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="hourglass" class="w-4 h-4 text-cyan-400"></i>
                        <span class="text-slate-400 hidden sm:inline">Hours:</span>
                        <input type="number" id="setting-shift-hours" class="bg-transparent border-none text-white focus:ring-0 w-16 font-medium text-base" value="9.5" step="0.5" min="1" max="24">
                    </div>
                </div>
            </header>

            <!-- Main Grid -->
            <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full items-start">
                
                <!-- SOD Board -->
                <div class="glass-panel rounded-3xl p-1 flex flex-col h-[calc(100vh-140px)] lg:h-[calc(100vh-160px)] relative group">
                    <!-- Board Header -->
                    <div class="p-5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <!-- Bar color updated to Blue -->
                            <div class="w-2 h-8 bg-blue-500 rounded-full shadow-[0_0_15px_rgba(59,130,246,0.5)]"></div>
                            <div>
                                <h3 class="font-bold text-lg text-white">SOD</h3>
                                <p class="text-xs text-slate-400 uppercase tracking-wider font-semibold">Start of Day</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <button id="btn-sod-report-settings" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-colors" title="Report Settings">
                                <i data-lucide="settings-2" class="w-4 h-4"></i>
                            </button>
                            <!-- Hover color updated -->
                            <button id="btn-copy-sod" class="p-2 hover:bg-white/10 rounded-lg text-blue-300 hover:text-white transition-colors group-hover:bg-blue-500/20" title="Copy SOD Report">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <!-- Add Button Updated -->
                            <button id="btn-add-sod" class="p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow-lg shadow-blue-500/30 transition-all active:scale-95">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="px-6 mb-4">
                        <div class="flex justify-between text-xs mb-1 font-medium">
                            <span class="text-slate-400">Planned Capacity</span>
                            <span id="sod-capacity-text" class="text-blue-300">0%</span>
                        </div>
                        <div class="w-full bg-slate-800/50 rounded-full h-1.5 overflow-hidden">
                            <!-- Gradient updated: Blue to Cyan -->
                            <div id="sod-progress-bar" class="bg-gradient-to-r from-blue-600 to-cyan-500 h-1.5 rounded-full transition-all duration-500 w-0"></div>
                        </div>
                    </div>

                    <!-- List Area -->
                    <div class="flex-1 overflow-y-auto px-4 pb-4 custom-scrollbar" id="sod-list">
                        <!-- Items injected here -->
                    </div>

                    <!-- Bin (Shows on drag) -->
                    <div id="bin-area" class="absolute bottom-4 left-4 right-4 h-16 border-2 border-dashed border-red-500/30 bg-red-500/10 rounded-xl hidden flex items-center justify-center text-red-300 z-20 transition-all duration-300">
                        <i data-lucide="trash-2" class="w-6 h-6 mr-2"></i> Drop here to delete
                    </div>
                </div>

                <!-- EOD Board (Remains Emerald/Green) -->
                <div class="glass-panel rounded-3xl p-1 flex flex-col h-[calc(100vh-140px)] lg:h-[calc(100vh-160px)] relative">
                     <!-- Board Header -->
                     <div class="p-5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-8 bg-emerald-500 rounded-full shadow-[0_0_15px_rgba(16,185,129,0.5)]"></div>
                            <div>
                                <h3 class="font-bold text-lg text-white">EOD</h3>
                                <p class="text-xs text-slate-400 uppercase tracking-wider font-semibold">End of Day</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-copy-eod" class="p-2 hover:bg-white/10 rounded-lg text-emerald-300 hover:text-white transition-colors group-hover:bg-emerald-500/20" title="Copy EOD Report">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <button id="btn-add-eod-manual" class="p-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg shadow-lg shadow-emerald-500/30 transition-all active:scale-95">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="px-6 mb-4">
                        <div class="flex justify-between text-xs mb-1 font-medium">
                            <span class="text-slate-400">Time Logged</span>
                            <span id="eod-capacity-text" class="text-emerald-300">0 hrs</span>
                        </div>
                        <div class="w-full bg-slate-800/50 rounded-full h-1.5 overflow-hidden">
                            <div id="eod-progress-bar" class="bg-gradient-to-r from-emerald-600 to-teal-400 h-1.5 rounded-full transition-all duration-500 w-0"></div>
                        </div>
                    </div>

                    <!-- List Area -->
                    <div class="flex-1 overflow-y-auto px-4 pb-4 custom-scrollbar" id="eod-list">
                        <!-- Items injected here -->
                        <div id="eod-placeholder" class="h-full flex flex-col items-center justify-center text-slate-500 opacity-50 border-2 border-dashed border-slate-700 rounded-xl m-2">
                            <i data-lucide="arrow-left" class="w-8 h-8 mb-2 lg:hidden"></i>
                            <i data-lucide="arrow-left" class="w-8 h-8 mb-2 hidden lg:block rotate-180 transform -translate-x-1/2"></i>
                            <p class="text-sm font-medium">Drag Completed SOD Tasks Here</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Add/Edit Item Modal -->
        <div id="item-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="glass-panel w-full max-w-sm p-6 rounded-2xl shadow-2xl transform scale-95 opacity-0 transition-all duration-200" id="item-modal-content">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-white">Add Item</h3>
                <form id="item-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Activity Description</label>
                        <input type="text" id="input-title" class="glass-input w-full px-4 py-3 rounded-xl text-base" placeholder="e.g., Check Emails" required autofocus autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Duration (minutes)</label>
                        <!-- Updated Container: flex-wrap + max-width logic to prevent bleed -->
                        <div class="flex flex-wrap gap-2 w-full">
                            <button type="button" class="quick-time bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 rounded-lg text-xs flex-grow-0 text-white" data-min="15">15m</button>
                            <button type="button" class="quick-time bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 rounded-lg text-xs flex-grow-0 text-white" data-min="30">30m</button>
                            <button type="button" class="quick-time bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 rounded-lg text-xs flex-grow-0 text-white" data-min="60">1h</button>
                            <!-- Input flex-grow to fill space, but min-width ensures it drops to new line if cramped -->
                            <input type="number" id="input-duration" class="glass-input flex-grow min-w-[100px] px-4 py-2 rounded-xl text-base" placeholder="Mins" required min="1">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" id="btn-cancel-modal" class="flex-1 py-3 rounded-xl border border-white/10 hover:bg-white/5 text-sm font-medium transition-colors text-white">Cancel</button>
                        <!-- Save Button Updated -->
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl shadow-lg shadow-blue-500/30 text-sm font-medium transition-all transform active:scale-95">Save</button>
                    </div>
                </form>
            </div>
        </div>

         <!-- Confirm Time Modal (Drag to EOD) -->
         <div id="confirm-time-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="glass-panel w-full max-w-sm p-6 rounded-2xl shadow-2xl" id="confirm-modal-content">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-emerald-500/20 p-2 rounded-full text-emerald-400"><i data-lucide="check-circle-2" class="w-6 h-6"></i></div>
                    <h3 class="text-xl font-bold text-white">Task Completed!</h3>
                </div>
                <p class="text-slate-300 text-sm mb-4">How long did <span id="confirm-task-name" class="font-bold text-white">Task Name</span> actually take?</p>
                <form id="confirm-time-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 ml-1">Actual Duration (minutes)</label>
                        <input type="number" id="confirm-duration" class="glass-input w-full px-4 py-3 rounded-xl text-base font-bold text-emerald-400" required min="1">
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" id="btn-cancel-confirm" class="flex-1 py-3 rounded-xl border border-white/10 hover:bg-white/5 text-sm font-medium transition-colors text-white">Cancel</button>
                        <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl shadow-lg shadow-emerald-500/30 text-sm font-medium transition-all transform active:scale-95">Confirm</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Settings Modal -->
        <div id="report-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="glass-panel w-full max-w-xs p-6 rounded-2xl shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-white">Report Options</h3>
                <div class="flex items-center justify-between mb-6">
                    <span class="text-sm text-slate-300">Simple View (AM/PM)</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="check-simple-view" class="sr-only peer">
                        <!-- Updated toggle color -->
                        <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <button id="btn-close-report-modal" class="w-full bg-white/10 hover:bg-white/20 py-2 rounded-xl text-sm text-white">Done</button>
            </div>
        </div>

        <!-- Toast Notification (With Action Button) -->
        <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-white/10 flex items-center gap-4 transition-all duration-300 translate-y-32 opacity-0 z-50">
            <div class="flex items-center gap-2">
                <i data-lucide="check" class="w-4 h-4 text-green-400"></i>
                <span id="toast-message" class="text-sm font-medium">Action successful</span>
            </div>
            <!-- Undo Button Color Updated -->
            <button id="btn-toast-undo" class="text-xs font-bold text-blue-300 hover:text-white uppercase tracking-wider hidden border-l border-white/20 pl-4">Undo</button>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration Strategy ---
        let isPreviewEnv = false;
        let firebaseConfig;
        let appId = 'default';

        if (typeof __firebase_config !== 'undefined') {
            isPreviewEnv = true;
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyBK2Js7VrxHw8uI5aK-0-pyA4EBZ5LTezE",
                authDomain: "loggr-2e8d5.firebaseapp.com",
                projectId: "loggr-2e8d5",
                storageBucket: "loggr-2e8d5.firebasestorage.app",
                messagingSenderId: "299955645307",
                appId: "1:299955645307:web:bd90625826f253a5326bde"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentUser = null;
        let sodItems = [];
        let eodItems = [];
        let settings = {
            startTime: "08:00",
            shiftHours: 9.5, 
            simpleReport: false
        };
        let currentDateStr = "";
        let isDragging = false;
        let draggedItemTemp = null; 
        
        // Auth State
        let isSignUp = false;

        // Undo State
        let deletedItemState = null; // { item, index, listType }
        let undoTimeout = null;

        // Theme State
        let isLightMode = false;

        // --- DOM Elements ---
        const views = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-view'),
            dashboard: document.getElementById('dashboard-view')
        };
        const sodListEl = document.getElementById('sod-list');
        const eodListEl = document.getElementById('eod-list');
        const eodPlaceholder = document.getElementById('eod-placeholder');
        const binArea = document.getElementById('bin-area');
        
        // --- Initialization ---
        function init() {
            lucide.createIcons();
            loadTheme();
            setupDate();
            setupDragAndDrop();
            setupEventListeners();
            setupKeyboardNavigation();
            
            // Handle Auth (Preview vs Production)
            if (isPreviewEnv) {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
            }

            onAuthStateChanged(auth, (user) => {
                views.loading.classList.add('opacity-0');
                setTimeout(() => views.loading.classList.add('hidden'), 500);

                if (user) {
                    currentUser = user;
                    document.getElementById('user-email-display').textContent = user.email || "Guest User";
                    showView('dashboard');
                    loadData();
                } else {
                    currentUser = null;
                    if (isPreviewEnv) {
                        // In preview, we auto-login, so this shouldn't happen often unless error
                    } else {
                        showView('auth');
                    }
                }
            });
        }

        // --- Theme Logic ---
        function loadTheme() {
            const saved = localStorage.getItem('loggr_theme');
            if (saved === 'light') {
                enableLightMode(true);
            }
        }

        function toggleTheme() {
            const body = document.body;
            isLightMode = !isLightMode;
            enableLightMode(isLightMode);
            localStorage.setItem('loggr_theme', isLightMode ? 'light' : 'dark');
        }

        function enableLightMode(enable) {
            isLightMode = enable;
            const body = document.body;
            const sunIcon = document.querySelector('.light-icon');
            const moonIcon = document.querySelector('.dark-icon');
            
            if (enable) {
                body.classList.add('light-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                body.classList.remove('light-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        function showView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            if(viewName === 'auth') {
                views.auth.classList.remove('hidden');
            } else if (viewName === 'dashboard') {
                views.dashboard.classList.remove('hidden');
                // Trigger animations
                sodListEl.parentElement.classList.add('animate-slide-up');
                eodListEl.parentElement.classList.add('animate-slide-up');
                setTimeout(() => {
                    sodListEl.parentElement.classList.remove('animate-slide-up');
                    eodListEl.parentElement.classList.remove('animate-slide-up');
                }, 600);
            }
        }

        function setupDate() {
            const now = new Date();
            const options = { day: 'numeric', month: 'short' };
            const dateText = now.toLocaleDateString('en-GB', options); // 25 Jan format
            document.getElementById('current-date').textContent = dateText;
            
            // Format for DB Key: YYYY-MM-DD
            const offset = now.getTimezoneOffset();
            const localDate = new Date(now.getTime() - (offset*60*1000));
            currentDateStr = localDate.toISOString().split('T')[0];
        }

        // --- Data Logic ---
        function getDocRef() {
            if (isPreviewEnv) {
                return doc(db, 'artifacts', appId, 'users', currentUser.uid, 'logs', currentDateStr);
            } else {
                return doc(db, "artifacts", "loggr-prod", "users", currentUser.uid, "logs", currentDateStr);
            }
        }

        async function loadData() {
            if (!currentUser) return;
            const docRef = getDocRef();
            
            // Realtime Listener
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    sodItems = data.sod || [];
                    eodItems = data.eod || [];
                    if(data.settings) settings = { ...settings, ...data.settings };
                } else {
                    // Initialize empty
                    sodItems = [];
                    eodItems = [];
                    saveData().catch(e => console.log("Init save silent fail:", e));
                }
                updateUI();
            }, (error) => {
                console.error("Data Load Error:", error);
                showToast("Error loading data: " + error.message);
            });
        }

        async function saveData() {
            if (!currentUser) return;
            const docRef = getDocRef();
            try {
                await setDoc(docRef, {
                    sod: sodItems,
                    eod: eodItems,
                    settings: settings,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
            } catch (e) {
                console.error("Save Error:", e);
                showToast("Error saving: " + e.code);
            }
        }

        // --- Undo Logic ---
        function deleteItemWithUndo(item, index, listType) {
            // 1. Save state
            deletedItemState = {
                item: { ...item },
                index: index,
                listType: listType
            };

            // 2. Remove from data
            if (listType === 'sod') {
                sodItems.splice(index, 1);
            } else {
                eodItems.splice(index, 1);
            }

            // 3. Update UI
            updateUI();
            saveData();

            // 4. Show Undo Toast
            showToast('Item deleted', true);

            // 5. Clear state after 5 seconds
            if (undoTimeout) clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => {
                deletedItemState = null;
                const undoBtn = document.getElementById('btn-toast-undo');
                undoBtn.classList.add('hidden');
            }, 5000);
        }

        function undoDelete() {
            if (!deletedItemState) return;

            const { item, index, listType } = deletedItemState;

            if (listType === 'sod') {
                sodItems.splice(index, 0, item);
            } else {
                eodItems.splice(index, 0, item);
            }

            updateUI();
            saveData();
            showToast('Action undone');
            
            // Clear state
            deletedItemState = null;
            if (undoTimeout) clearTimeout(undoTimeout);
        }

        // --- Time Calculations ---
        function calculateTimes() {
            let currentMinutes = timeStringToMinutes(settings.startTime);
            
            sodItems = sodItems.map(item => {
                const startMins = currentMinutes;
                const endMins = currentMinutes + parseInt(item.duration);
                currentMinutes = endMins;
                
                return {
                    ...item,
                    startTime: minutesToTime(startMins),
                    endTime: minutesToTime(endMins),
                    rawStart: startMins 
                };
            });
        }

        function timeStringToMinutes(timeStr) {
            const [hours, mins] = timeStr.split(':').map(Number);
            return (hours * 60) + mins;
        }

        function minutesToTime(totalMinutes) {
            let hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            const ampm = hours >= 12 ? 'pm' : 'am';
            
            if (hours > 12) hours -= 12;
            if (hours === 0) hours = 12; 

            if (Math.floor(totalMinutes / 60) === 12) hours = 12;

            return `${hours}:${mins.toString().padStart(2, '0')}${ampm}`;
        }

        function formatDuration(minutes) {
            const hours = minutes / 60;
            const formatted = parseFloat(hours.toFixed(1));
            if (formatted <= 1) return `${formatted}hr`;
            return `${formatted}hrs`;
        }

        // --- UI Rendering ---
        function updateUI() {
            calculateTimes();
            
            // Settings inputs
            document.getElementById('setting-start-time').value = settings.startTime;
            document.getElementById('setting-shift-hours').value = settings.shiftHours;
            document.getElementById('check-simple-view').checked = settings.simpleReport;

            // Render SOD
            renderList(sodListEl, sodItems, 'sod');

            // Render EOD
            renderList(eodListEl, eodItems, 'eod');
            
            // Placeholder logic
            if (eodItems.length === 0) {
                eodListEl.appendChild(eodPlaceholder);
                eodPlaceholder.classList.remove('hidden');
            } else {
                eodPlaceholder.classList.add('hidden');
            }

            // Progress Bars
            const shiftMins = settings.shiftHours * 60;
            const totalSodMins = sodItems.reduce((acc, curr) => acc + parseInt(curr.duration), 0);
            
            // SOD Progress
            const sodPct = Math.min((totalSodMins / shiftMins) * 100, 100);
            const sodBar = document.getElementById('sod-progress-bar');
            sodBar.style.width = `${sodPct}%`;
            
            if (totalSodMins > shiftMins) {
                // Gradient updated: Violet/Fuchsia -> Blue/Cyan
                sodBar.classList.remove('from-blue-600', 'to-cyan-500');
                sodBar.classList.add('bg-red-500');
                document.getElementById('sod-capacity-text').textContent = `${formatDuration(totalSodMins)} (Over)`;
                document.getElementById('sod-capacity-text').classList.add('text-red-400');
            } else {
                sodBar.classList.add('from-blue-600', 'to-cyan-500');
                sodBar.classList.remove('bg-red-500');
                document.getElementById('sod-capacity-text').textContent = `${Math.round(sodPct)}% Planned`;
                document.getElementById('sod-capacity-text').classList.remove('text-red-400');
            }

            // EOD Progress
            const totalEodMins = eodItems.reduce((acc, curr) => acc + parseInt(curr.duration), 0);
            const eodPct = Math.min((totalEodMins / shiftMins) * 100, 100);
            document.getElementById('eod-progress-bar').style.width = `${eodPct}%`;
            document.getElementById('eod-capacity-text').textContent = formatDuration(totalEodMins);

            lucide.createIcons();
        }

        function renderList(container, items, type) {
            // Clear but keep placeholder if EOD
            if(type === 'eod') {
                while(container.children.length > 1) { 
                    if(container.lastChild !== eodPlaceholder) container.removeChild(container.lastChild);
                    else break;
                }
                container.innerHTML = '';
            } else {
                container.innerHTML = '';
            }

            items.forEach((item, index) => {
                const el = createCard(item, index, type);
                container.appendChild(el);
            });
        }

        function createCard(item, index, type) {
            const div = document.createElement('div');
            // Added tabindex="0" for keyboard focus
            div.className = 'glass-card p-4 mb-3 rounded-xl cursor-grab active:cursor-grabbing flex justify-between items-center group relative overflow-hidden focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500';
            div.setAttribute('tabindex', '0');
            div.dataset.id = item.id;
            div.dataset.index = index; 
            div.dataset.type = type;

            // Gradient line on left: Updated SOD to Blue
            const barColor = type === 'sod' ? 'bg-blue-500' : 'bg-emerald-500';
            div.innerHTML = `
                <div class="absolute left-0 top-0 bottom-0 w-1 ${barColor} opacity-70"></div>
                <div class="flex-1 pl-3">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-sm text-white">${item.title}</span>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="edit-btn p-1 hover:bg-white/10 rounded" title="Edit" tabindex="-1"><i data-lucide="pencil" class="w-3 h-3 text-slate-300"></i></button>
                            ${type === 'sod' ? `<button class="move-eod-btn p-1 hover:bg-emerald-500/20 text-emerald-400 rounded" title="Complete" tabindex="-1"><i data-lucide="check" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center text-xs text-slate-400 font-mono">
                        ${type === 'sod' 
                            ? `<span class="bg-white/5 px-2 py-0.5 rounded text-blue-300">${item.startTime} - ${item.endTime}</span>` 
                            : `<span class="bg-white/5 px-2 py-0.5 rounded text-emerald-300">${formatDuration(item.duration)}</span>`
                        }
                    </div>
                </div>
            `;

            // Event Listeners for buttons
            const editBtn = div.querySelector('.edit-btn');
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                openModal(type, item);
            });

            if (type === 'sod') {
                const moveBtn = div.querySelector('.move-eod-btn');
                moveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    initiateMoveToEod(item);
                });
            }

            return div;
        }

        // --- Drag & Drop (SortableJS) ---
        function setupDragAndDrop() {
            const commonOptions = {
                group: 'shared',
                animation: 350, 
                easing: "cubic-bezier(0.25, 1, 0.5, 1)", 
                delay: 100, 
                delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                forceFallback: false, 
                onStart: () => {
                    binArea.classList.remove('hidden');
                    // FIX: Increased bottom padding to pb-40
                    sodListEl.classList.add('pb-40');
                    eodListEl.classList.add('pb-40');
                },
                onEnd: () => {
                    binArea.classList.add('hidden');
                    // FIX: Remove extra padding
                    sodListEl.classList.remove('pb-40');
                    eodListEl.classList.remove('pb-40');
                }
            };

            // SOD List
            Sortable.create(sodListEl, {
                ...commonOptions,
                onEnd: (evt) => {
                    binArea.classList.add('hidden');
                    sodListEl.classList.remove('pb-40');
                    eodListEl.classList.remove('pb-40');

                    if (evt.to === sodListEl && evt.from === sodListEl) {
                        const item = sodItems.splice(evt.oldIndex, 1)[0];
                        sodItems.splice(evt.newIndex, 0, item);
                        updateUI();
                        saveData();
                    }
                },
                onAdd: (evt) => {
                    const itemEl = evt.item;
                    const oldIndex = evt.oldIndex; 
                    const item = eodItems[oldIndex];
                    
                    itemEl.remove();

                    eodItems.splice(oldIndex, 1);
                    sodItems.splice(evt.newIndex, 0, item);
                    
                    updateUI();
                    saveData();
                    showToast('Returned to SOD');
                }
            });

            // EOD List
            Sortable.create(eodListEl, {
                ...commonOptions,
                onAdd: (evt) => {
                    const itemEl = evt.item;
                    const oldIndex = evt.oldIndex; 
                    const item = sodItems[oldIndex];
                    itemEl.remove();
                    initiateMoveToEod(item, oldIndex);
                },
                onEnd: (evt) => {
                    binArea.classList.add('hidden');
                    sodListEl.classList.remove('pb-40');
                    eodListEl.classList.remove('pb-40');

                    if (evt.to === eodListEl && evt.from === eodListEl) {
                         const item = eodItems.splice(evt.oldIndex, 1)[0];
                         eodItems.splice(evt.newIndex, 0, item);
                         updateUI();
                         saveData();
                    }
                }
            });

            // Bin Droppable
            new Sortable(binArea, {
                group: 'shared',
                ghostClass: 'hidden',
                onAdd: (evt) => {
                    const fromList = evt.from === sodListEl ? 'sod' : 'eod';
                    const idx = evt.oldIndex;
                    
                    const item = fromList === 'sod' ? sodItems[idx] : eodItems[idx];
                    
                    // Centralized Delete with Undo
                    deleteItemWithUndo(item, idx, fromList);
                    
                    evt.item.remove(); 
                }
            });
        }

        function initiateMoveToEod(item, sodIndexToRemove = null) {
            draggedItemTemp = { ...item, sodIndex: sodIndexToRemove !== null ? sodIndexToRemove : sodItems.indexOf(item) };
            
            document.getElementById('confirm-task-name').textContent = item.title;
            document.getElementById('confirm-duration').value = item.duration;
            
            const modal = document.getElementById('confirm-time-modal');
            const content = document.getElementById('confirm-modal-content');
            modal.classList.remove('hidden');
            content.classList.remove('opacity-0', 'scale-95');
            
            document.getElementById('confirm-duration').focus();
            document.getElementById('confirm-duration').select();
        }

        // --- Keyboard Navigation ---
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                const activeEl = document.activeElement;
                const isCard = activeEl.classList.contains('glass-card');

                if (isCard) {
                    const type = activeEl.dataset.type;
                    const index = parseInt(activeEl.dataset.index);
                    const list = type === 'sod' ? sodItems : eodItems;
                    const item = list[index];

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const next = activeEl.nextElementSibling;
                        if (next && next.classList.contains('glass-card')) next.focus();
                        else if (!next && type === 'sod' && eodListEl.children.length > 0 && !eodListEl.children[0].id) {
                             if(eodListEl.querySelector('.glass-card')) eodListEl.querySelector('.glass-card').focus();
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prev = activeEl.previousElementSibling;
                        if (prev && prev.classList.contains('glass-card')) prev.focus();
                        else if (!prev && type === 'eod' && sodListEl.children.length > 0) {
                            sodListEl.lastElementChild.focus();
                        }
                    }
                    
                    else if (e.key === 'Delete' || e.key === 'Backspace') {
                        e.preventDefault();
                        if (confirm('Delete this item?')) {
                            deleteItemWithUndo(item, index, type);
                        }
                    }

                    else if (e.key === 'Enter') {
                        e.preventDefault();
                        openModal(type, list[index]);
                    }
                }
            });
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Auth Toggle (Sign Up / Sign In)
            const btnSwitchAuth = document.getElementById('btn-switch-auth');
            btnSwitchAuth.addEventListener('click', () => {
                isSignUp = !isSignUp;
                const title = document.getElementById('auth-title');
                const btnSubmit = document.getElementById('btn-auth-submit');
                const switchText = document.getElementById('auth-switch-text');
                
                if (isSignUp) {
                    title.textContent = "Create Profile";
                    btnSubmit.innerHTML = `<span>Create Account</span><i data-lucide="user-plus" class="w-4 h-4"></i>`;
                    switchText.textContent = "Already have an account?";
                    btnSwitchAuth.textContent = "Sign In";
                } else {
                    title.textContent = "Welcome to Loggr";
                    btnSubmit.innerHTML = `<span>Sign In</span><i data-lucide="arrow-right" class="w-4 h-4"></i>`;
                    switchText.textContent = "Don't have an account?";
                    btnSwitchAuth.textContent = "Create Profile";
                }
                lucide.createIcons();
            });

            // Auth Submit
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('remember-me').checked;
                const errEl = document.getElementById('auth-error');
                
                errEl.classList.add('hidden');
                
                try {
                    // Set Persistence
                    await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);

                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showToast("Profile created successfully");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    errEl.textContent = error.message.replace('Firebase: ', '');
                    errEl.classList.remove('hidden');
                }
            });

            // Forgot Password
            document.getElementById('btn-forgot-password').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const errEl = document.getElementById('auth-error');
                const successEl = document.getElementById('auth-success');
                
                if (!email) {
                    errEl.textContent = "Please enter your email address first.";
                    errEl.classList.remove('hidden');
                    return;
                }

                try {
                    await sendPasswordResetEmail(auth, email);
                    successEl.textContent = "Password reset email sent!";
                    successEl.classList.remove('hidden');
                    errEl.classList.add('hidden');
                } catch (error) {
                    errEl.textContent = error.message;
                    errEl.classList.remove('hidden');
                }
            });

            // Logout
            document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

            // Theme Toggle
            document.getElementById('btn-theme-toggle').addEventListener('click', toggleTheme);

            // Settings Change
            document.getElementById('setting-start-time').addEventListener('change', (e) => {
                settings.startTime = e.target.value;
                updateUI();
                saveData();
            });
            document.getElementById('setting-shift-hours').addEventListener('change', (e) => {
                settings.shiftHours = parseFloat(e.target.value) || 9.5;
                updateUI();
                saveData();
            });

            // Modals
            const modal = document.getElementById('item-modal');
            const modalContent = document.getElementById('item-modal-content');

            document.getElementById('btn-add-sod').addEventListener('click', () => openModal('sod'));
            document.getElementById('btn-add-eod-manual').addEventListener('click', () => openModal('eod'));
            document.getElementById('btn-cancel-modal').addEventListener('click', closeModal);
            
            // Submit Item
            document.getElementById('item-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('input-title').value;
                const duration = parseInt(document.getElementById('input-duration').value);
                const type = modal.dataset.type;
                const isEdit = modal.dataset.isEdit === 'true';
                
                if (isEdit) {
                    const id = modal.dataset.id;
                    const list = type === 'sod' ? sodItems : eodItems;
                    const idx = list.findIndex(i => i.id === id);
                    if (idx > -1) {
                        list[idx].title = title;
                        list[idx].duration = duration;
                    }
                } else {
                    const newItem = {
                        id: Date.now().toString(),
                        title,
                        duration
                    };
                    if (type === 'sod') sodItems.push(newItem);
                    else eodItems.push(newItem);
                }
                
                closeModal();
                updateUI();
                saveData();
            });

            // Quick Time Buttons
            document.querySelectorAll('.quick-time').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('input-duration').value = btn.dataset.min;
                });
            });

            // Confirm Move to EOD Form
            document.getElementById('confirm-time-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const actualDuration = parseInt(document.getElementById('confirm-duration').value);
                
                eodItems.push({
                    id: Date.now().toString(), 
                    title: draggedItemTemp.title,
                    duration: actualDuration
                });
                
                if (draggedItemTemp.sodIndex > -1) {
                    sodItems.splice(draggedItemTemp.sodIndex, 1);
                }
                
                const m = document.getElementById('confirm-time-modal');
                m.classList.add('hidden');
                draggedItemTemp = null;
                
                updateUI();
                saveData();
                showToast('Moved to EOD');
            });

            document.getElementById('btn-cancel-confirm').addEventListener('click', () => {
                 const m = document.getElementById('confirm-time-modal');
                 m.classList.add('hidden');
                 updateUI();
            });

            // Reports
            document.getElementById('btn-sod-report-settings').addEventListener('click', () => {
                document.getElementById('report-modal').classList.remove('hidden');
            });
            document.getElementById('btn-close-report-modal').addEventListener('click', () => {
                document.getElementById('report-modal').classList.add('hidden');
                settings.simpleReport = document.getElementById('check-simple-view').checked;
                saveData();
            });
            
            document.getElementById('btn-copy-sod').addEventListener('click', generateSODReport);
            document.getElementById('btn-copy-eod').addEventListener('click', generateEODReport);
            
            // Undo Action
            document.getElementById('btn-toast-undo').addEventListener('click', undoDelete);
        }

        // --- Helper Functions ---
        function openModal(type, item = null) {
            const modal = document.getElementById('item-modal');
            const content = document.getElementById('item-modal-content');
            
            modal.dataset.type = type;
            modal.dataset.isEdit = item ? 'true' : 'false';
            if (item) modal.dataset.id = item.id;
            
            document.getElementById('modal-title').textContent = item ? 'Edit Item' : (type === 'sod' ? 'Add to SOD' : 'Add to EOD');
            document.getElementById('input-title').value = item ? item.title : '';
            document.getElementById('input-duration').value = item ? item.duration : '30';
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('opacity-0', 'scale-95');
                document.getElementById('input-title').focus();
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('item-modal');
            const content = document.getElementById('item-modal-content');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showToast(msg, showUndo = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            
            const undoBtn = document.getElementById('btn-toast-undo');
            if (showUndo) {
                undoBtn.classList.remove('hidden');
            } else {
                undoBtn.classList.add('hidden');
            }

            t.classList.remove('translate-y-32', 'opacity-0');
            
            // Auto hide logic handled in deleteItemWithUndo for undo scenarios
            // For normal toasts:
            if (!showUndo) {
                setTimeout(() => {
                    t.classList.add('translate-y-32', 'opacity-0');
                }, 2000);
            }
        }

        // --- Report Generation ---
        function generateSODReport() {
            calculateTimes(); 
            
            let text = `SOD - ${document.getElementById('current-date').textContent}\n\n`;
            
            if (settings.simpleReport) {
                const amItems = sodItems.filter(i => {
                     return i.rawStart < 720;
                });
                const pmItems = sodItems.filter(i => i.rawStart >= 720);
                
                if(amItems.length > 0) {
                    text += `AM\n`;
                    amItems.forEach(i => text += `• ${i.title}\n`);
                    text += `\n`;
                }
                if(pmItems.length > 0) {
                    text += `PM\n`;
                    pmItems.forEach(i => text += `• ${i.title}\n`);
                }
            } else {
                sodItems.forEach(i => {
                    text += `• ${i.startTime} - ${i.endTime} ${i.title}\n`;
                });
            }
            
            copyToClipboard(text);
        }

        function generateEODReport() {
            let text = `EOD - ${document.getElementById('current-date').textContent}\n\n`;
            
            eodItems.forEach(i => {
                text += `• ${i.title} (${formatDuration(i.duration)})\n`;
            });
            
            copyToClipboard(text);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Report copied to clipboard');
            }).catch(err => {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Report copied to clipboard');
            });
        }

        init();

    </script>
</body>
</html>
